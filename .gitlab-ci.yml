stages:
  - sonarcloud-check
  - deployment
  - cleanup
 #sonar 
variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
sonarcloud-check:
  stage: sonarcloud-check
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  only:
    - merge_requests
    - master
    - develop

deploy:development:
  stage: deployment
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
  - ssh $SERVER_USER@$SERVER_HOST "cd /Data/goaly/staging-tsel-goaly_laravel/web && git checkout master && git pull origin master"
  only:
    - master
  tags:
    - staging-tsel-goaly

clean:
  stage: cleanup
  script:
  - echo "Time to clean up"
  after_script:
  - rm -rf * $CI_PROJECT_DIR
  only:
    - master
  tags:
    - staging-tsel-goaly
